version: '3.8'

services:
    pilosa_coordinator:
        image: pilosa/pilosa:latest
        networks:
        - pilosanetwork
        deploy:
            replicas: 1
            endpoint_mode: dnsrr
        command: [
            'server',
            '--cluster.coordinator=true',
            '--bind=0.0.0.0:10101',
            '--advertise=0.0.0.0:15001'
            '--gossip.port=11101',
            '--gossip.seeds=pilosa_workers:11101',
            '--data-dir=/opt/pilosa/data'
        ]
        volumes:
            - /mnt:/opt/pilosa/data
        ports:
          - target: 10101
            published: 10101
            protocol: tcp
            mode: host
          - target: 11101
            published: 11101
            protocol: tcp
            mode: host
          - target: 15001
            published: 15001
            protocol: tcp
            mode: host
    pilosa_workers:
        image: pilosa/pilosa:latest
        networks:
        - pilosanetwork
        depends_on:
        - pilosa_coordinator
        deploy:
            replicas: ${NUM_WORKERS}
            placement:
                max_replicas_per_node: 1
            endpoint_mode: dnsrr
        command: [
            'server',
            '--bind=localhost:10101',
            '--advertise=0.0.0.0:15001'
            '--gossip.port=11101',
            '--gossip.seeds=pilosa_workers:11101',
            '--gossip.seeds=pilosa_workers:11101,pilosa_coordinator:11101',
            '--data-dir=/opt/pilosa/data'
        ]
        volumes:
            - /mnt:/opt/pilosa/data
        ports:
          - target: 10101
            published: 10101
            protocol: tcp
            mode: host
          - target: 11101
            published: 11101
            protocol: tcp
            mode: host
          - target: 15001
            published: 15001
            protocol: tcp
            mode: host

networks:
    pilosanetwork:
        driver: overlay
        attachable: true
